---
title: 处理复杂表单
date: "2023-05-13"
language: zh-CN
category: other
---

前端开发中，复杂表单一直是个难点。本文将探讨如何控制表单的复杂度并尝试总结出一些最佳实践。

### 类比四维空间

如果把表单比作一个四维空间，那么它的四个维度分别为:

- 点: 表单中的一个字段
- 线: 表单中的两个相互影响的字段
- 面: 多个字段的集合 (表单中的多个相互影响的字段, 多步表单的其中一步等)
- 时间: 表单提交前的任何异步操作 (比如加载数据, 异步校验等等)

注：类比只是为了更好地理解，不要纠结于细节，因为只要是类比就一定会有失真。

### 单个字段不一定简单

表单是一个复合结构，它由多个字段组成，每个字段都有自己的类型和校验规则。

虽然字段的类型有很多种，比如文本、数字、日期、下拉列表、单选框、多选框等，但由于行为都比较固定，所以为这些简单字段本身构建 UI 和校验不是什么难事。

但是有些时候字段本身就是个复合字段或者虽是单一字段但由复合 UI 组成，这时就需要通过合理封装来隐藏其内部的复杂性。

### 字段之间的相互影响

单个字段尚且容易管理，但是当表单中的字段增多，并且字段之间相互影响时，表单的复杂度就会大大增加。字段之间的相互影响可能包括:

- 字段 A 的值决定字段 B 的可见性
- 字段 A 的值决定字段 B 的可编辑性
- 字段 A 的值决定字段 B 的默认值
- 字段 A 的值决定字段 B 的校验规则

### 一个例子

说了这么多还是很难产生直观的感受，下面举一个例子来说明，这也是我实际工作中遇到的需求。

目前所在公司的产品是智能路由器，核心功能之一是通过创建规则来控制设备能否访问某个目标地址。下面是创建规则的 UI:

![创建规则](/images/create-rule-form.png)

除了最后的 *Notes* 字段外，其他字段都是必填的，而且 *Notes* 字段比较独立，和其他字段不会相互影响。这里对其他字段做一些介绍:

- **Action**: 简单的下拉列表。有两个选项: *Allow* 和 *Block*, 分别表示允许访问和阻止访问。
- **Matching**: 复合字段, 代表要允许和阻止的访问目标。它由 *Target Type* 和 *Target Value* 两个字段组成，其中 *Target Type* 是一个下拉列表，而且根据 *Target Type* 的不同 *Target Value* 可能是文本框也可能是下拉列表还可能自己就是一个复合结构。
- **On**: 复合字段，代表规则所作用的范围。分为两级: 一级是 Box 一级是该 Box 下的 Device，每级都有一个下拉列表，而且根据上级的不同下级的选项也不同。
- **Schedule**: 复合字段，代表规则的生效时间。虽然它本身有些复杂，但是它不会影响其他字段。


